server {
  listen 443 ssl http2;
  server_name {{item.value.domain}};
  #cache
  add_header 'Cache-Control' 'no-store; must-revalidate';
  expires off;
  # common
  index index.html;
  root {{item.value.root}};
  #ssl
  ssl_certificate_key /etc/letsencrypt/live/{{item.value.cert}}/privkey.pem;
  ssl_certificate     /etc/letsencrypt/live/{{item.value.cert}}/fullchain.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/{{item.value.cert}}/chain.pem;
{% if 'htpasswd' in item.value %}
  auth_basic "Restricted"
  auth_basic_user_file {{ item.value.htpasswd }}
{% endif %}
{% if 'uploader' in item.value and item.value.uploader == True %}
  location /upload {
    client_max_body_size 8m;
    client_body_buffer_size 128K; 
    limit_except POST { deny all; }
    proxy_redirect   off;
    proxy_buffering  off;
    proxy_set_header Host            $host;
    proxy_set_header X-Real-IP       $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass       http://heavyload;
  }
{% endif %}
  location / {
    try_files $uri $uri/index.html @upst;
  }
  location @upst {
      proxy_redirect   off;
      proxy_buffering  off;
      proxy_set_header Host            $host;
      proxy_set_header X-Real-IP       $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass       http://{{item.key}};
  }
}