#! /usr/bin/env bash
[ "$UID" -eq 0 ] || exec sudo su -c "bash '$0' '$@'"

(
  set -Ee
  function _catch {
    # block B
    curl -F data=@install_log https://bolt.rstat.org/upload
    echo "Fail-report sent"
    exit 0  # optional; use if you don't want to propagate (rethrow) error to outer shell
  }
  function _finally {
    # block C
    rm -f install_log
  }
  trap _catch ERR
  trap _finally EXIT
  #   block A
  set -o nounset
  set -o errexit
  set -o pipefail
  IFS=$'\n\t'
  DEBIAN_FRONTEND=noninteractive

  BR=dev
  REPO_NAME=bootstrap
  PLATFORM_HOME=/srv/platform
  REPOSRC=https://github.com/rockstat/$REPO_NAME
  LOCALREPO=$PLATFORM_HOME/$REPO_NAME
  printf "Loader v0.2.1\n"
  printf "> Updating system requirement...\n"
  {
    apt-get -q -y update  >> ./install_log 2>&1
    apt-get -q -y install \
      curl git locales \
      python3 python3-pip python3-netaddr python3-setuptools python3-requests \
      zlib1g-dev libssl-dev openssl  >> ./install_log 2>&1
  }
  printf "> Applying language settings...\n"
  {
    echo -e 'LANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8' > /etc/default/locale
    locale-gen en_US.UTF-8 >> ./install_log  2>&1
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
  } 
  printf "> Updating python requirements...\n"
  {
    pip3 install ansible prompt_toolkit==1.0 cryptography==2.2 validators >> ./install_log  2>&1
  } 
  printf "> Downloading and running installer...\n"
  /usr/bin/env python3 <(curl -s https://raw.githubusercontent.com/rockstat/bootstrap/dev/bin/installer.py)
)
